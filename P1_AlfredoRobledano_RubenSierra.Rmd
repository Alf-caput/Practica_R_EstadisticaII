---
title: "Prueba 1 - ANOVA"
author: "Rubén Sierra Serrano y Alfredo Robledano Abasolo"
date: "2023-03-20"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Creación y descripción de la base de datos.

El primer paso para trabajar sobre una base de datos es, conocerla, es decir, conocer el contenido de la base de datos y, además, ser capaces de clasificar las diferentes variables en función de su clase o, lo que es lo mismo, saber distinguir las variables continuas de las discretas (categóricas).

Otro punto interesante es el de crear nuevas variables dependiendo de los resultados que estamos buscando según nuestros intereses.

Leemos a continuación la base de datos:

```{r results='asis', echo=FALSE}
data <- read.csv('healthcare-dataset-stroke-data.csv', sep = ',')
head(data)
```

Encontramos una base de datos que consta de 5110 observaciones y de 12 variables.

Algunas de estas variables sirven para identificar a cada una de las personas que se ha hecho seguimiento, como son la edad o el género. Otras, sin embargo, hacen referencia a temas de salud, como el nivel de glucosa, el índice de masa corporal o si tienen o han tenido problemas cardiovasculares.

Entendemos que es interesante, para este estudio, comprobar qué factores pueden influir sobre el índice de masa corporal (BMI en inglés), tomamos esta como nuestra variable objetivo.

Por último, encontramos variables que hacen referencia a hábitos de personas, como pueden ser el tipo de trabajo y con que regularidad fuman.

Breve descripción de las variables encontradas en la base de datos:

\begin{itemize}
\item \textbf {id:} es un identificador de los pacientes sobre los que se está realizando el estudio.
\item \textbf {gender:} hace referencia al sexo de los pacientes.
\item \textbf {age:} representa la edad, en años, de los pacientes.
\item \textbf {hypertension:} variable binaria que representa si el paciente tiene hipertensión o no.
\item \textbf {heart_disease:} indica si el paciente ha tenido previamente problemas cardiacos).
\item \textbf {ever_married:} indica si el paciente se ha casado o no.
\item \textbf {work_type:} tipo de trabajo, clasificado de la siguiente forma: Govt_job (funcionario), Private (trabajador del sector privado), Self-employed \item \textbf (autónomo), Never_worked (sin ningún tipo de experiencia laboral) y children (niño y, por tanto, sin experiencia laboral).
\item \textbf {residence_type:} localización geográfica de la residencia en la que habita el paciente, puede ser rural (área rural) o urban (área urbana).
\item \textbf {avg_glucose_level:} nivel de glucosa media del paciente medida en mg/dL
\item \textbf {bmi:} índice de masa corporal del paciente
\item \textbf {smoking_status:} hábito de consumo de tabaco del paciente, clasificado de la siguiente forma: smokes (fumador actual), formerly smoked (fumador en \item \textbf el pasado) y never smoked (nunca ha fumado)
\item \textbf {stroke:} variable binaria que indica si el paciente ha tenido un ataque cardiaco (1) o no (0).
\end{itemize}

Vamos a eliminar la variable id ya que se trata de un identificador empleado para diferenciar a los pacientes:

```{r results='asis', echo=FALSE}
df <- data[,-c(1)]
```

## Limpieza de la base de datos - estadística descriptiva

Una vez hemos definido las variables y sabemos lo que significan, tenemos que depurar la base de datos para poder trabajar con ella.

En la variable gender, observamos que hay una única obsevación (no significativa) que adopta el valor Other, la convertimos en NA:

```{r}
df$gender <- ifelse(df$gender == "Other", NA, df$gender)
```


De las variables que hemos elegido el índice de masa corportal (bmi) tiene 3.9% de variables que son NA, por tanto, eliminaremos esas observaciones.
Por otro lado existe un número significativo de observaciones que tienen variable smoking_status de valor Unknown, realizamos un breve análisis de su relación con el bmi.
```{r}
boxplot(bmi~smoking_status, data=df)
```
Si realizamos un diagrama de cajas que relacione las variables bmi y smoking_status observamos que entre las variables que no son unknown no hay mucha diferencia, pero esta si difiere y por tanto al realizar anova saldría como valor de variable significativo unknown pero realmente no sabríamos porque al no especificarse un valor concreto. Descartamos esas observaciones al no darnos información útil.
```{r}
df$smoking_status <- ifelse(df$smoking_status == "Unknown", NA, df$smoking_status)
```

Hemos convertido en NA todos aquellos valores de variables de observaciones no útiles.

```{r}
library(inspectdf);
show_plot(inspect_na(df))
```
Eliminamos todas aquellas observaciones no útiles.

```{r}
df <- na.omit(df)
show_plot(inspect_na(df))
```

Lo siguiente que debemos realizar es un estudio de la naturaleza de las variables, es decir, asignar el tipo factor a aquellas que consideremos categóricas y comprobar que las numéricas estén bien identificadas:

```{r}
show_plot(inspect_types(df))
```

Tenemos 5 variables de tipo char que pasaremos a factor. Además, debemos pasar a factor las variables que representan categorías aún siendo variables numéricas, en nuestro caso las variable hypertension, heart_disease y stroke.

```{r}
df[,c(1, 3, 4, 5, 6, 7, 10, 11)] <- lapply(df[,c(1, 3, 4, 5, 6, 7, 10, 11)], factor)
summary(df)
```

Observamos que hay 3 variables continuas, de las que posteriormente estudiaremos las distribuciones y se tomarán las decisiones oportunas: 
• age: Edad de cada individuo. 
• avg_glucose_level: Nivel de glugosa promedio de cada individuo 
• bmi: Índice de masa corporal de cada individuo
En contraposición, hay 5 variables discretas: 
• gender: Sexo de los pacientes.
• hypertension: Determina si los pacientes tienen hipertensión.
• heart_disease: Determina si los pacientes han tenido problemas cardiacos.
• work_type: Tipo de trabajo que ejerce el paciente. 
• ever_married: Determina si los pacientes se han casado. 
• Residence_type: Lugar de residencia de los pacientes.
• smoking_status: Nivel de tabaquismo de los pacientes.
• stroke: Determina si el paciente ha tenido previamente infartos.

Nos podemos percatar que la variable edad puede tomar valores no enteros, por simplicidad convertiremos la edad a valores enteros y trabajaremos en meses porque parte de la muestra son bebés.

```{r}
df[2]<-lapply(df[2],function(x) round(x*12))
colnames(df)[2]  <- "months"  
summary(df)
```

Analizando el summary, la media y el tercer cuartil del IMC y de los niveles de glucosa distan mucho de sus valores máximos, por tanto, podemos concluir que tiene valores outliners.

Lo primero que tenemos que hacer para eliminar los outliners es graficar las funciones numéricas para observa cuánto se aleja la cola del resto de la función:

```{r}
library(inspectdf);
show_plot(inspect_num(df))
```

En el IMC, los outliners son los valores que se escapan por las colas, de tal forma que una persona es muy extraño que tenga un IMC ínfimo o superior al 50%. Por tanto, nuestros outliners serán los valores menores a un 15% y mayores a un 50%:

```{r}
df <- subset(df, bmi > 15 & bmi < 50)
summary(df)
```
En los niveles de glucosa, los outliners son los valores que se escapan por las colas, de tal forma que una persona es muy extraño que tenga un nivel de glucosa superior a los 250 mg/dL:

```{r}
df <- subset(df, avg_glucose_level< 225)
summary(df)
```

# Análisis a priori - influencia de las variables. 

Ahora que conocemos la base de datos y la hemos depurado, vamos a empezar a sacar algunas conclusiones. Por ejemplo, nos podría interesar comprobar si el índice de masa corporal viene influido por el tabaquismo:
```{r}
boxplot(bmi ~ smoking_status, data = df, ylab = "IMC", xlab = "Tabaquismo")
```
También podría ser interesante mirar la influencia entre los problemas cardiacos, tener hipertensión, el sexo o si viven en el campo y el IMC:
```{r}
boxplot(bmi ~ heart_disease, data = df, ylab = "IMC", xlab = "Cardiopatías", names = c("No", "Sí"))
boxplot(bmi ~ hypertension, data = df, ylab = "IMC", xlab = "Hipertensión", names = c("No", "Sí"))
boxplot(bmi  ~  gender, data = df, ylab = "IMC", xlab = "Sexo", names = c("Mujeres", "Hombres") )
boxplot(bmi  ~  Residence_type, data = df, ylab = "IMC", xlab = "Residencia", names = c("Rural", "Urbana"))
```
Vamos a comprobar, de forma gráfica, si el sexo puede afectar a la hipertensión, los ataques cardiacos y las cardiopatías. De esta forma, en el futuro, podremos realizar más comprobaciones de forma analítica. 
```{r}
spineplot(table(df$hypertension,df$gender), xaxlabels = c("Sin hipertensión", "Con hipertensión"))
spineplot(table(df$stroke,df$gender), xaxlabels = c("No ataque cardiaco", "Ataque cardiaco"))
spineplot(table(df$heart_disease,df$gender), xaxlabels = c("Sin cardiopatías", "Con cardiopatías"))
```
# Intervalo de confianza
En este apartado crearemos un intervalo de confianza para el IMC. 
Hemos visto anteriormente el estimador puntual para este valor, aproximadamente 
el 29.7%, pero vamos a crear un intervalo de confianza para este valor y poder estimar 
cuánto valdría este valor en la población. 

Queremos hacer el intervalo de confianza para el IMC \textbf{media}.
```{r}
# Intervalo para la media 

conf <- t.test(x =  df$bmi,                   # Muestra 1
               y = NULL,                      # Muestra 2
               alternative = c("two.sided"),  # Tipo de intervalo
               paired = FALSE,                # Variables dependientes
               var.equal = FALSE,             # Varianzas iguales
               conf.level = 0.95)             # Nivel de confianza (1-nivel significación)

# Muestro el resultado del intervalo

conf$conf.int
```

# Contraste de hipótesis
Hemos visto de forma gráfica, que la residencia no afectaba al IMC pero tener hipertensión sí podía influir. 

Crearemos un primer contraste de forma analítica para comprobar que la media de IMC entre los que viven en el campo y en la ciudad es  igual. Es decir, queremos plantear el siguiente contraste de hipótesis:

$$ \left\{ \begin{array}{lc}
             H_{0}: & \mu_{rural} = \mu_{urbano} \\
             H_{1}: & \mu_{rural} \neq \mu_{urbano}
             \end{array}
\right. $$

```{r}
# Contraste para la diferencia de medias
rural <- df[df$Residence_type == 'Rural', 'bmi']
urbano <- df[df$Residence_type == 'Urban', 'bmi']

t.test(x = rural,                   # Muestra 1
       y = urbano,                   # Muestra 2
       alternative = c("two.sided"),  # Signo hipótesis alternativa
       paired = FALSE,                # Variables dependientes
       var.equal = FALSE,             # Varianzas iguales
       conf.level = 0.95)             # Nivel de confianza (1-nivel significación)
```
Como el p-valor es mayor que el nivel de significación, podemos concluir que no
hay evidencias suficientes para rechazar $H_{0}$ y por tanto no existen diferencias
entre el IMC entre las personas que tienen residencia rural y residencia urbana. 

Ahora vamos a comprobar qué pasa con las personas con hipertensión. Para ello, vamos a plantear
la siguiente hipótesis, pues gráficamente es la que hemos visto que se cumple: 

$$ \left\{ \begin{array}{lc}
             H_{0}: & \mu_{hipertensión} \leq \mu_{no hipertensión} \\
             H_{1}: & \mu_{hipertensión} > \mu_{no hipertensión}
             \end{array}
   \right. $$
```{r}
# Contraste para la diferencia de medias

yes <- df[df$hypertension == 1, 'bmi']
no <- df[df$hypertension == 0, 'bmi']

t.test(x = yes,                       # Muestra 1
       y = no,                        # Muestra 2
       alternative = c("greater"),    # Signo hipótesis alternativa
       paired = FALSE,                # Variables dependientes
       var.equal = FALSE,             # Varianzas iguales
       conf.level = 0.99)             # Nivel de confianza (1-nivel significación)

```
El p-valor es pequeño, lo que quiere decir que nuestro estadístico de 
diferencia de medias está en la región crítica, por lo que tenemos
evidencias suficientes para rechazar la hipótesis nula y podemos concluir que 
hay diferencia entre el IMC de personas con hipertensión y las que no tienen hipertensión, teniendo las personas con hipertensión un mayor IMC.
#ANOVA
Por último, vamos a comprobar si el tabaquismo puede influir en el IMC. Gráficamente hemos visto que las personas que nunca han fumado suelen tener un IMC menor.

Definimos el siguiente contraste:

$$ \left\{ \begin{array}{lc}
             H_{0}: & \mu_{no fumador} = \mu_{exfumador} = \mu_{fumador}\\
             H_{1}: & Diferentes
             \end{array}
\right. $$

```{r}
# Aplicamos ANOVA
anova_str <- aov(bmi ~ smoking_status, data = df)
summary(anova_str)
```
Como resultado, obtenemos la tabla de ANOVA vista en clase, con la diferencia de
encontrar el p-valor en lugar del valor teórico para la distribución de la F. 

El criterio de rechazo es el mismo que tenemos en los contrastes de hipótesis, 
es decir, si el p-valor es mayor que el nivel de significación, rechazamos $H_{0}$.

En este caso tenemos un p-valor muy pequeño, bajo un nivel de significación 0.05, 
rechazamos $H_{0}$, es decir, no hay evidencias suficientes para aceptar que las 
medias de IMC en los diferentes grupos según si la persona nunca ha fumado, es exfumador o fuma actualmente
sean iguales. Podemos concluir que estas medias son diferentes y por tanto, el tabaquismo sí es un factor influyente en el IMC.